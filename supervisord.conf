[supervisord]
nodaemon=true
logfile=/dev/null
logfile_maxbytes=0
pidfile=/run/supervisord.pid

; ---------------------------------------------------------------------------
; uvicorn – FastAPI backend on port 8000
; ---------------------------------------------------------------------------
[program:uvicorn]
; Use the venv-aware python installed by uv sync
command=/app/.venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
directory=/app/apps/api_server
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
; If uvicorn exits, bring down the whole container
startsecs=2
stopwaitsecs=10

; ---------------------------------------------------------------------------
; nginx – reverse proxy + static file server on port 80
; ---------------------------------------------------------------------------
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
startsecs=2
stopwaitsecs=5

; ---------------------------------------------------------------------------
; If ANY managed program enters FATAL state, stop everything so the container
; exits with a non-zero code (prevents silent failures).
; ---------------------------------------------------------------------------
[eventlistener:exit-on-fatal]
command=bash -c "while read line; do echo \"$line\"; kill -SIGTERM $(cat /run/supervisord.pid); done"
events=PROCESS_STATE_FATAL
