# nginx.conf â€“ single-container reverse proxy for gridone
#
# Responsibilities:
#   1. Serve the built Vite SPA at / (static files from /app/static)
#   2. Proxy /api/* requests to the FastAPI backend (uvicorn on 127.0.0.1:8000)
#   3. Handle WebSocket upgrade for /api/ws/* paths

worker_processes auto;
pid /run/nginx.pid;
error_log /dev/stderr warn;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile    on;
    tcp_nopush  on;

    access_log /dev/stdout;

    # WebSocket connection map: set $connection_upgrade to "upgrade" when the
    # client sends an Upgrade header, otherwise keep it as "close".
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen 80;
        server_name _;

        # --- API: proxy HTTP + WebSocket to uvicorn on port 8000 -----------
        #
        # /api/ is stripped by the rewrite so FastAPI sees the original paths
        # (e.g. /devices, /ws/devices). This keeps the backend code unchanged.
        location /api/ {
            rewrite ^/api(/.*)$ $1 break;

            proxy_pass         http://127.0.0.1:8000;
            proxy_http_version 1.1;

            # Headers required for WebSocket upgrade
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            # Standard proxy headers
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Disable buffering for WebSocket / SSE streams
            proxy_buffering off;

            # Long timeout for WebSocket connections (1 hour)
            proxy_read_timeout  3600s;
            proxy_send_timeout  3600s;
        }

        # --- SPA: serve static assets and fallback to index.html -----------
        root /app/static;
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
